name: üìä Tests And Coverage
# Allow to post comments back on the pull-requests
permissions: write-all 

# This concurrency group will stop any running the tests on the same branch if a new commit is
# pushed before the previous job finished. This can help saving precious github minutes 
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

on:
  # make this reusable by other workflows
  workflow_call:
  # Triggered automatically on all pull requests to main
  pull_request:
    branches:
      - main
    types: [opened, reopened, synchronize, ready_for_review]
    paths-ignore:
      - '**.md' # do not trigger job if only docs were updated

jobs:
  run-tests-with-coverage:
    # do not run job if the pull request is a draft
    if: github.event.pull_request.draft == false
    environment: 
      name: Prod
    runs-on: ubuntu-latest
    timeout-minutes: 300
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v3
      - name: ‚öôÔ∏è Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true # This will allow to benefits from the cache mechanism
      - name: üëÅÔ∏è Check Flutter version
        run: flutter --version   
      - name: ‚öôÔ∏è Install LCOV
        run: |
          sudo apt-get update
          sudo apt-get -y install lcov
      - name: üîê Create [env]_secrets.json file
        id: create-json
        uses: jsdaniell/create-json@1.1.2
        with:
          name: "prod_secrets.json"
          json: |
            '{
              "SECRET_API_KEY_1":"${{ secrets.SECRET_API_KEY_1 }}", 
              "SECRET_API_KEY_2":"${{ secrets.SECRET_API_KEY_2 }}"
            }'
          dir: 'lib/config/secrets'
      - name: ‚ñ∂Ô∏è Run tests with generate coverage report
        run: |
          flutter pub get;
          flutter test --coverage;
      # This action will do something only when triggered from a PR
      - name: üìÑ Report code coverage
        uses: zgosalvez/github-actions-report-lcov@v3
        with:
          coverage-files: coverage/lcov.*.info
          minimum-coverage: 100
          # This will make the HTML code coverage report downloadable as an artifact
          artifact-name: code-coverage-report
          # This token is provided by Actions, you do not need to create your own token.
          github-token: ${{ secrets.GITHUB_TOKEN }}
          working-directory: ./
          # A new comment will be posted on the PR on every run (As opposed to update previous comment)
          update-comment: false